<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EPC QR Code Generator</title>

  <!-- QR library (creates a canvas) -->
  <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>

  <style>
    :root {
      --accent: #007bff;
    }
    * { box-sizing: border-box; }
    body{
      font-family: Arial, Helvetica, sans-serif;
      background:#f4f4f4;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:100vh;
      margin:0;
      padding:20px;
    }
    #main{
      width:100%;
      max-width:520px;
      background:white;
      padding:20px;
      border-radius:10px;
      box-shadow:0 6px 18px rgba(0,0,0,.08);
    }
    h1 { font-size:1.1rem; margin:0 0 10px; }
    label { display:block; margin-top:10px; font-weight:600; }
    .optional { font-weight:400; color:#666; font-size:.9rem; margin-left:6px }
    input[type=text], select, textarea {
      width:100%;
      padding:10px;
      border-radius:6px;
      border:1px solid #ddd;
      margin-top:6px;
      font-size:1rem;
    }
    .row { display:flex; gap:10px; }
    .row > * { flex:1; }
    .button {
      display:inline-block;
      background:var(--accent);
      color:white;
      border:none;
      padding:12px 14px;
      border-radius:8px;
      cursor:pointer;
      font-size:1rem;
      margin-top:12px;
      width:100%;
    }
    .secondary {
      background:#6c757d;
    }
    #qr-area { display:flex; gap:20px; align-items:center; margin-top:16px; flex-wrap:wrap; }
    #qr-canvas { width:200px; height:200px; border:1px solid #eee; background:white; display:block; margin:auto; }
    #qr-data { font-family:monospace; white-space:pre-wrap; background:#fafafa; padding:8px; border-radius:6px; border:1px dashed #eee; font-size:.87rem; }
    .actions { display:flex; gap:8px; margin-top:10px; }
    .small { font-size:.9rem; padding:8px 10px; }
    .note { color:#555; font-size:.9rem; margin-top:8px; }
  </style>
</head>
<body>
  <div id="main">
    <h1>EPC / SEPA QR-code generator</h1>
    <form id="epcForm" onsubmit="return generateQR();">
      <label for="bname">Naam begunstigde</label>
      <input id="bname" type="text" maxlength="70" placeholder="Bijv. Stichting Voorbeeld" required>

      <label for="iban">IBAN</label>
      <input id="iban" type="text" maxlength="34" placeholder="Bijv. BE72000000001616" value="BE" required>

      <div class="row">
        <div>
          <label for="bic">BIC <span class="optional">(optioneel)</span></label>
          <input id="bic" type="text" maxlength="11" placeholder="Bijv. BPOTBEB1 (optioneel)">
        </div>
        <div>
          <label for="amount">Bedrag (EUR) <span class="optional">(optioneel)</span></label>
          <input id="amount" type="text" maxlength="15" placeholder="Bijv. 12.34">
        </div>
      </div>

      <label for="reference">Betaalreferentie / Structured reference <span class="optional">(optioneel)</span></label>
      <input id="reference" type="text" maxlength="35" placeholder="Bijv. RF... of leeg">

      <label for="remittance">Vrije mededeling / Remittance (optioneel)</label>
      <textarea id="remittance" rows="2" maxlength="140" placeholder="Bijv. Factuur 2025-001"></textarea>

      <div class="actions">
        <button class="button" type="submit">QR Code genereren</button>
        <button type="button" class="button secondary small" onclick="clearAll()">Clear</button>
      </div>

      <p class="note">
        Dit genereert een EPC (SCT) payload per EPC-richtlijnen (payload begint met <code>BCD</code>).
        Banks/apps that support EPC will read this and populate a SEPA credit transfer. :contentReference[oaicite:1]{index=1}
      </p>
    </form>

    <div id="qr-area" aria-live="polite">
      <div style="flex:0 0 220px; text-align:center;">
        <canvas id="qr-canvas" width="220" height="220" style="display:block; margin:0 auto"></canvas>
        <div style="margin-top:8px;">
          <button id="downloadBtn" class="button small" onclick="downloadPNG()" style="width:48%; display:inline-block">Download PNG</button>
          <button id="copyPayloadBtn" class="button small secondary" onclick="copyPayload()" style="width:48%; display:inline-block">Copy payload</button>
        </div>
      </div>

      <div style="flex:1; min-width:220px;">
        <label>Gegenereerde EPC payload</label>
        <div id="qr-data">Geen QR gegenereerd</div>
      </div>
    </div>
  </div>

  <script>
    // --- Helpers & validation ---
    function validateIBAN(iban) {
      // Basic IBAN structure check (country code + digits/letters). Not full checksum here.
      iban = iban.replace(/\s+/g,'').toUpperCase();
      return /^[A-Z]{2}[0-9A-Z]{13,32}$/.test(iban);
    }

    function validateBIC(bic) {
      return bic === '' || /^[A-Z]{4}[A-Z]{2}[A-Z0-9]{2}([A-Z0-9]{3})?$/.test(bic.toUpperCase());
    }

    function validateAmount(amount) {
      if (!amount) return true; // optional
      // Accept "12" "12.3" "12.34" but not comma
      return /^\d+(\.\d{1,2})?$/.test(amount);
    }

    function trimToLength(s, max) { return (s || '').trim().substring(0, max); }

    // Build the EPC payload according to the common EPC layout:
    // ServiceTag (BCD)
    // Version (001)
    // Character set (1 = UTF-8)
    // Identification (SCT)
    // BIC (optional)
    // Name (max 70)
    // IBAN
    // Amount (EUR + decimal with dot, e.g. EUR12.34) (optional)
    // Purpose or structured reference (we put reference here) (optional)
    // Remittance (unstructured) (optional)
    // Information (optional)  -- we will leave empty if not used
    //
    // See EPC guidelines (EPC069-12) for details. (Name and IBAN are required by the scheme).
    // Source: EPC guidelines & Wikipedia. :contentReference[oaicite:2]{index=2}
    function buildEpcPayload({ bic, name, iban, amount, reference, remittance }) {
      const lines = [];
      lines.push('BCD');         // Service tag
      lines.push('001');         // Version (001 is commonly used)
      lines.push('1');           // Character set: 1 = UTF-8
      lines.push('SCT');         // Identification: SCT (SEPA Credit Transfer)
      lines.push(bic || '');     // BIC (optional, empty line allowed)
      lines.push(trimToLength(name, 70) || ''); // Name (required)
      lines.push(iban.replace(/\s+/g,'').toUpperCase() || ''); // IBAN (required)
      if (amount) {
        // EPC expects decimal point and 2 decimals commonly; prefix with EUR
        const formatted = parseFloat(amount).toFixed(2).replace(/\.00$/, '.00'); // keep 2 decimals
        lines.push('EUR' + formatted);
      } else {
        lines.push('');
      }
      lines.push(trimToLength(reference, 35) || '');    // Payment reference or structured ref (optional)
      lines.push(trimToLength(remittance, 140) || '');   // Unstructured remittance (optional)
      lines.push(''); // Additional information (left empty)
      return lines.join('\n').replace(/\u0000/g,''); // ensure no nulls
    }

    // --- QR generation using QRious (canvas) ---
    let qr = new QRious({ element: document.getElementById('qr-canvas'), value: '', size: 220, padding: 10 });

    function generateQR() {
      const name = document.getElementById('bname').value.trim();
      const iban = document.getElementById('iban').value.trim().replace(/\s+/g,'').toUpperCase();
      const bic  = document.getElementById('bic').value.trim().toUpperCase();
      const amount = document.getElementById('amount').value.trim();
      const reference = document.getElementById('reference').value.trim();
      const remittance = document.getElementById('remittance').value.trim();

      // Basic required checks
      if (!name) { alert('Voer de naam van de begunstigde in.'); return false; }
      if (!iban) { alert('Voer een IBAN in.'); return false; }
      if (!validateIBAN(iban)) { alert('Ongeldige IBAN (controleer op juistheid).'); return false; }
      if (!validateBIC(bic)) { alert('Ongeldige BIC.'); return false; }
      if (!validateAmount(amount)) { alert('Ongeldig bedrag. Gebruik bijv. 12.34 (punt als decimaalscheider).'); return false; }

      // Build payload
      const payload = buildEpcPayload({ bic, name, iban, amount: amount || null, reference, remittance });

      // Write to QR canvas
      qr.value = payload;

      // Show payload text
      document.getElementById('qr-data').textContent = payload;

      // enable download button
      document.getElementById('downloadBtn').disabled = false;
      return false; // prevent form submit reload
    }

    function downloadPNG() {
      const canvas = document.getElementById('qr-canvas');
      // Attempt to force white background if transparent
      const tmp = document.createElement('canvas');
      tmp.width = canvas.width;
      tmp.height = canvas.height;
      const ctx = tmp.getContext('2d');
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0,0,tmp.width,tmp.height);
      ctx.drawImage(canvas, 0, 0);
      const data = tmp.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = data;
      a.download = 'epc-qr.png';
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    function copyPayload() {
      const payload = document.getElementById('qr-data').textContent;
      if (!payload || payload === 'Geen QR gegenereerd') {
        alert('Geen payload om te kopiëren.');
        return;
      }
      navigator.clipboard?.writeText(payload).then(() => {
        alert('Payload gekopieerd naar klembord.');
      }, () => {
        alert('Kan niet kopiëren via clipboard API; selecteer en kopieer handmatig.');
      });
    }

    function clearAll() {
      document.getElementById('bname').value = '';
      document.getElementById('iban').value = 'BE';
      document.getElementById('bic').value = '';
      document.getElementById('amount').value = '';
      document.getElementById('reference').value = '';
      document.getElementById('remittance').value = '';
      qr.value = '';
      document.getElementById('qr-data').textContent = 'Geen QR gegenereerd';
    }

    // Initialise
    document.addEventListener('DOMContentLoaded', function(){
      document.getElementById('downloadBtn').disabled = true;
    });

  </script>
</body>
</html>
