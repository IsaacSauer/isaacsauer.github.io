<!DOCTYPE html>
<html lang="nl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>EPC QR Code Generator</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff" />
    <meta name="description" content="Genereer een EPC / SEPA QR-code voor betalingen." />
    <meta name="keywords" content="EPC, SEPA, QR code, QR-code, generator, betaling, payment, IBAN, BIC, structured reference, betaalreferentie" />
    <meta name="author" content="Isaac Sauer" />
    <link rel="apple-touch-icon" href="../icons/icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="EPC QR Code Generator">
    <link rel="icon" type="image/png" href="../icons/icon-192.png" />
    <link rel="shortcut icon" href="../icons/icon-192.png" />

    <!-- QR library (creates a canvas) -->
    <script
      src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
    <script>
      // Register service worker
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker.register("../service-worker.js")
            .then(reg => console.log("Service Worker registered:", reg))
            .catch(err => console.error("Service Worker failed:", err));
        });
      }

      // --- Remember install-time params using IndexedDB (iOS-safe) ---
      (function() {
        function openDB(cb) {
          const req = indexedDB.open("PWAData", 1);
          req.onupgradeneeded = e => {
            e.target.result.createObjectStore("store");
          };
          req.onsuccess = e => cb(e.target.result);
        }

        function saveInstallUrl(url) {
          openDB(db => {
            const tx = db.transaction("store", "readwrite");
            tx.objectStore("store").put(url, "installUrl");
          });
        }

        function getInstallUrl(cb) {
          openDB(db => {
            const tx = db.transaction("store", "readonly");
            const req = tx.objectStore("store").get("installUrl");
            req.onsuccess = () => cb(req.result);
          });
        }

        const hasParams = window.location.search.length > 0;

        if (hasParams) {
          getInstallUrl(stored => {
            if (!stored) {
              saveInstallUrl(window.location.href);
              console.log("Saved install-time URL:", window.location.href);
            }
          });
        }

        window.addEventListener("load", () => {
          if (!hasParams) {
            getInstallUrl(stored => {
              if (stored) {
                console.log("Restoring install-time URL:", stored);
                window.location.replace(stored);
              }
            });
          }
        });
      })();
    </script>
    <style>
    :root {
      --accent: #007bff;
    }
    * { box-sizing: border-box; }
    body{
      font-family: Arial, Helvetica, sans-serif;
      background:#f4f4f4;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:100vh;
      margin:0;
      padding:20px;
    }
    #main{
      width:100%;
      max-width:520px;
      background:white;
      padding:20px;
      border-radius:10px;
      box-shadow:0 6px 18px rgba(0,0,0,.08);
    }
    h1 { font-size:1.1rem; margin:0 0 10px; }
    label { display:block; margin-top:10px; font-weight:600; }
    .optional { font-weight:400; color:#666; font-size:.9rem; margin-left:6px }
    input[type=text], select, textarea {
      width:100%;
      padding:10px;
      border-radius:6px;
      border:1px solid #ddd;
      margin-top:6px;
      font-size:1rem;
    }
    .row { display:flex; gap:10px; }
    .row > * { flex:1; }
    .button {
      display:inline-block;
      background:var(--accent);
      color:white;
      border:none;
      padding:12px 14px;
      border-radius:8px;
      cursor:pointer;
      font-size:1rem;
      margin-top:12px;
      width:100%;
    }
    .secondary {
      background:#6c757d;
    }
    #qr-area { display:flex; gap:20px; align-items:center; margin-top:16px; flex-wrap:wrap; }
    #qr-canvas { width:200px; height:200px; border:1px solid #eee; background:white; display:block; margin:auto; }
    #qr-data { font-family:monospace; white-space:pre-wrap; background:#fafafa; padding:8px; border-radius:6px; border:1px dashed #eee; font-size:.87rem; }
    .actions { display:flex; gap:8px; margin-top:10px; }
    .small { font-size:.9rem; padding:8px 10px; }
    .note { color:#555; font-size:.9rem; margin-top:8px; }

    /* Overlay styles */
    .overlay {
      position: fixed;
      top:0; left:0; right:0; bottom:0;
      background: rgba(255,255,255,0.8);
      backdrop-filter: blur(6px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .overlay-content {
      background: white;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 6px 18px rgba(0,0,0,.2);
      text-align: center;
      position: relative;
      animation: fadeIn 0.3s ease;
    }

    .close-btn {
      position: absolute;
      top: 10px;
      right: 12px;
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
    #qr-overlay-canvas {
      width: 90vw;
      height: auto;
      max-width: 500px;
      max-height: 500px;
    }

  </style>
  </head>
  <body>
    <div id="main">
      <h1>EPC / SEPA QR-code generator</h1>
      <form id="epcForm" onsubmit="return generateQR();">
        <label for="bname">Naam begunstigde</label>
        <input id="bname" type="text" maxlength="70"
          placeholder="Bijv. Stichting Voorbeeld" required>

        <label for="iban">IBAN</label>
        <input id="iban" type="text" maxlength="34"
          placeholder="Bijv. BE72000000001616" value="BE" required>

        <div class="row">
          <div>
            <label for="bic">BIC <span
                class="optional">(optioneel)</span></label>
            <input id="bic" type="text" maxlength="11"
              placeholder="Bijv. BPOTBEB1 (optioneel)">
          </div>
          <div>
            <label for="amount">Bedrag (EUR) <span
                class="optional">(optioneel)</span></label>
            <input id="amount" type="text" maxlength="15"
              placeholder="Bijv. 12.34">
          </div>
        </div>

        <label for="reference">Betaalreferentie / Structured reference <span
            class="optional">(optioneel)</span></label>
        <input id="reference" type="text" maxlength="35"
          placeholder="Bijv. RF... of leeg">

        <label for="remittance">Vrije mededeling / Remittance
          (optioneel)</label>
        <textarea id="remittance" rows="2" maxlength="140"
          placeholder="Bijv. Factuur 2025-001"></textarea>

        <div class="actions">
          <button class="button" type="submit">QR Code genereren</button>
          <button type="button" class="button secondary small"
            onclick="clearAll()">Clear</button>
        </div>

      </form>

      <div id="qr-area" aria-live="polite">
        <div style="flex:0 0 220px; text-align:center;">
          <canvas id="qr-canvas" width="220" height="220"
            style="display:block; margin:0 auto"></canvas>
          <div style="margin-top:8px;">
            <button id="downloadBtn" class="button small"
              onclick="downloadPNG()"
              style="width:48%; display:inline-block">Download PNG</button>
            <button id="copyPayloadBtn" class="button small secondary"
              onclick="copyPayload()"
              style="width:48%; display:inline-block">Copy payload</button>
          </div>
        </div>

        <div style="flex:1; min-width:220px;">
          <label>Gegenereerde EPC payload</label>
          <div id="qr-data">Geen QR gegenereerd</div>
        </div>
      </div>
    </div>
    <!-- Overlay for QR -->
    <div id="qr-overlay" class="overlay">
        <button class="close-btn" onclick="closeOverlay()">✕</button>
      <div class="overlay-content">
        <canvas id="qr-overlay-canvas"></canvas>
        <div style="margin-top:10px; font-size:1rem; color:#333;">Scan de
          QR-code</div>
      </div>
    </div>

    <script>
    function validateIBAN(iban) {
      iban = iban.replace(/\s+/g,'').toUpperCase();
      return /^[A-Z]{2}[0-9A-Z]{13,32}$/.test(iban);
    }

    function validateBIC(bic) {
      return bic === '' || /^[A-Z]{4}[A-Z]{2}[A-Z0-9]{2}([A-Z0-9]{3})?$/.test(bic.toUpperCase());
    }

    function validateAmount(amount) {
      if (!amount) return true;
      return /^\d+(\.\d{1,2})?$/.test(amount);
    }

    function trimToLength(s, max) { return (s || '').trim().substring(0, max); }

    function buildEpcPayload({ bic, name, iban, amount, reference, remittance }) {
      const lines = [];
      lines.push('BCD');
      lines.push('001');
      lines.push('1');
      lines.push('SCT');
      lines.push(bic || '');
      lines.push(trimToLength(name, 70) || '');
      lines.push(iban.replace(/\s+/g,'').toUpperCase() || '');
      if (amount) {
        const formatted = parseFloat(amount).toFixed(2).replace(/\.00$/, '.00');
        lines.push('EUR' + formatted);
      } else {
        lines.push('');
      }
      lines.push(trimToLength(reference, 35) || '');
      lines.push(trimToLength(remittance, 140) || '');
      lines.push('');
      return lines.join('\n').replace(/\u0000/g,'');
    }

    let qr = new QRious({ element: document.getElementById('qr-canvas'), value: '', size: 220, padding: 10 });
    let qrOverlay = new QRious({
      element: document.getElementById('qr-overlay-canvas'),
      value: '',
      size: 800, // high resolution for crisp scaling
    });

    function generateQR() {
      const name = document.getElementById('bname').value.trim();
      const iban = document.getElementById('iban').value.trim().replace(/\s+/g,'').toUpperCase();
      const bic  = document.getElementById('bic').value.trim().toUpperCase();
      const amount = document.getElementById('amount').value.trim();
      const reference = document.getElementById('reference').value.trim();
      const remittance = document.getElementById('remittance').value.trim();

      if (!name) { alert('Voer de naam van de begunstigde in.'); return false; }
      if (!iban) { alert('Voer een IBAN in.'); return false; }
      if (!validateIBAN(iban)) { alert('Ongeldige IBAN.'); return false; }
      if (!validateBIC(bic)) { alert('Ongeldige BIC.'); return false; }
      if (!validateAmount(amount)) { alert('Ongeldig bedrag.'); return false; }

      const payload = buildEpcPayload({ bic, name, iban, amount: amount || null, reference, remittance });

      // Update both small QR and big QR
      qr.value = payload;
      qrOverlay.value = payload;

      document.getElementById('qr-data').textContent = payload;

      // Update URL params
      const params = [];
      params.push("name=" + encodeURIComponent(name));
      params.push("iban=" + encodeURIComponent(iban));
      if (bic) params.push("bic=" + encodeURIComponent(bic));
      if (remittance) params.push("remittance=" + encodeURIComponent(remittance));
      const newUrl = window.location.pathname + "?" + params.join("&");
      window.history.replaceState(null, "", newUrl);

      document.getElementById('downloadBtn').disabled = false;

      // Show overlay
      document.getElementById('qr-overlay').style.display = "flex";

      return false;
    }

    function closeOverlay() {
      document.getElementById('qr-overlay').style.display = "none";
    }


    function downloadPNG() {
      const canvas = document.getElementById('qr-canvas');
      const tmp = document.createElement('canvas');
      tmp.width = canvas.width;
      tmp.height = canvas.height;
      const ctx = tmp.getContext('2d');
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0,0,tmp.width,tmp.height);
      ctx.drawImage(canvas, 0, 0);
      const data = tmp.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = data;
      a.download = 'epc-qr.png';
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    function copyPayload() {
      const payload = document.getElementById('qr-data').textContent;
      if (!payload || payload === 'Geen QR gegenereerd') {
        alert('Geen payload om te kopiëren.');
        return;
      }
      navigator.clipboard?.writeText(payload).then(() => {
        alert('Payload gekopieerd naar klembord.');
      }, () => {
        alert('Kan niet kopiëren; selecteer en kopieer handmatig.');
      });
    }

    function clearAll() {
      document.getElementById('bname').value = '';
      document.getElementById('iban').value = 'BE';
      document.getElementById('bic').value = '';
      document.getElementById('amount').value = '';
      document.getElementById('reference').value = '';
      document.getElementById('remittance').value = '';
      qr.value = '';
      document.getElementById('qr-data').textContent = 'Geen QR gegenereerd';
    }

    document.addEventListener('DOMContentLoaded', function(){
      document.getElementById('downloadBtn').disabled = true;

      // --- Prefill from URL ---
      const params = new URLSearchParams(window.location.search);
      if (params.has("name")) document.getElementById("bname").value = decodeURIComponent(params.get("name"));
      if (params.has("iban")) document.getElementById("iban").value = decodeURIComponent(params.get("iban"));
      if (params.has("bic")) document.getElementById("bic").value = decodeURIComponent(params.get("bic"));
      if (params.has("remittance")) document.getElementById("remittance").value = decodeURIComponent(params.get("remittance"));
    });
  </script>
  </body>
</html>
